{% extends "base.html" %}

{% block title %}Duty Schedule - Student Duty Management{% endblock %}

{% block content %}
<style>
    .day-box {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #3498db;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .day-header {
        font-size: 20px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
        text-align: center;
    }

    .day-date {
        font-size: 14px;
        color: #7f8c8d;
        font-weight: normal;
        display: block;
        margin-top: 5px;
    }

    .shift-section {
        margin-bottom: 15px;
        flex: 1;
    }

    .shift-label {
        font-size: 16px;
        font-weight: 600;
        color: #7f8c8d;
        margin-bottom: 10px;
        text-align: center;
    }

    .duty-slots {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .duty-slot {
        min-height: 80px;
        background: #f8f9fa;
        border: 2px dashed #bdc3c7;
        border-radius: 10px;
        padding: 12px;
        transition: all 0.3s;
        position: relative;
    }

    .duty-slot.drag-over {
        background: #e8f4f8;
        border-color: #3498db;
        border-style: solid;
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .duty-slot.filled {
        border-style: solid;
        border-color: #3498db;
        background: #f0f7ff;
    }

    .student-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 18px;
        border-radius: 10px;
        cursor: grab;
        user-select: none;
        transition: all 0.3s;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .student-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    .student-card:active {
        cursor: grabbing;
        opacity: 0.7;
        transform: translateY(0);
    }

    .student-card.dragging {
        opacity: 0.5;
    }

    .student-name {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
        line-height: 1.3;
    }

    .student-grade {
        font-size: 14px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .grade-badge {
        background: rgba(255, 255, 255, 0.25);
        padding: 3px 10px;
        border-radius: 12px;
        font-weight: 600;
    }

    .student-pool {
        position: sticky;
        top: 20px;
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }

    .student-pool h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
    }

    .student-pool-item {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        cursor: grab;
        user-select: none;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .student-pool-item:hover {
        background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        transform: translateX(8px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .student-pool-item:active {
        cursor: grabbing;
    }

    .student-pool-item .student-name {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .student-pool-item .student-grade {
        font-size: 13px;
        opacity: 0.9;
    }

    .slot-label {
        position: absolute;
        top: 3px;
        right: 5px;
        font-size: 10px;
        color: #95a5a6;
        font-weight: 600;
        background: white;
        padding: 2px 6px;
        border-radius: 8px;
    }

    .am-shift { border-left-color: #f39c12; }
    .pm-shift { border-left-color: #9b59b6; }

    /* Grid layout for days */
    .days-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Trash bin styles */
    .trash-bin {
        position: fixed;
        bottom: -200px;
        left: 50%;
        transform: translateX(-50%);
        width: 200px;
        height: 150px;
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        border-radius: 15px 15px 0 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 60px;
        transition: bottom 0.3s ease-out;
        z-index: 9999;
        box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
        cursor: pointer;
    }

    .trash-bin.visible {
        bottom: 0;
    }

    .trash-bin.drag-over-trash {
        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        transform: translateX(-50%) scale(1.1);
    }

    .trash-bin-text {
        font-size: 18px;
        margin-top: 10px;
        font-weight: bold;
    }

    @media (max-width: 1400px) {
        .days-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 1000px) {
        .days-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .days-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2>üìÖ Drag & Drop Duty Schedule</h2>
            <p style="color: #7f8c8d; margin-top: 5px;">Drag students to assign duties - Drag to trash bin to remove</p>
        </div>
        {% if selected_term and week_data %}
        <button onclick="regenerateWeek()" class="btn btn-success">
            üîÑ Auto-Generate This Week
        </button>
        {% endif %}
    </div>
</div>

{% if not selected_term %}
<div class="card" style="margin-top: 20px; text-align: center; padding: 60px; background: #fff3cd; border-left: 4px solid #ffc107;">
    <h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è No Active Term</h3>
    <p style="color: #856404; margin-bottom: 25px;">Create a term and generate a schedule to start assigning duties</p>
    <a href="{{ url_for('manage_terms') }}" class="btn btn-primary">Go to Terms</a>
</div>
{% else %}

<!-- Term Selection and Week Navigation -->
<div class="card" style="margin-top: 20px; background: #f8f9fa;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div>
            <h3 style="color: #2c3e50; margin-bottom: 10px;">{{ selected_term.name }}</h3>
            <p style="color: #7f8c8d; margin: 0;">
                {{ selected_term.start_date.strftime('%B %d') }} - {{ selected_term.end_date.strftime('%B %d, %Y') }}
            </p>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            {% if current_week > 1 %}
            <a href="?term={{ selected_term.id }}&week={{ current_week - 1 }}" class="btn btn-secondary">‚Üê Prev</a>
            {% endif %}

            <select onchange="window.location.href='?term={{ selected_term.id }}&week=' + this.value" 
                    class="form-control" style="width: 150px;">
                {% for w in range(1, selected_term.weeks + 1) %}
                <option value="{{ w }}" {% if w == current_week %}selected{% endif %}>Week {{ w }}</option>
                {% endfor %}
            </select>

            {% if current_week < selected_term.weeks %}
            <a href="?term={{ selected_term.id }}&week={{ current_week + 1 }}" class="btn btn-secondary">Next ‚Üí</a>
            {% endif %}
        </div>
    </div>
</div>

{% if week_data %}
<!-- Week Header -->
<div class="card" style="margin-top: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h2 style="color: white; margin-bottom: 10px;">Week {{ week_data.weekly_assignment.week_number }} - Table {{ week_data.weekly_assignment.table_number }} on Duty</h2>
    <p style="opacity: 0.9;">
        {{ week_data.weekly_assignment.start_date.strftime('%B %d') }} - {{ week_data.weekly_assignment.end_date.strftime('%B %d, %Y') }}
    </p>
</div>

<!-- Main Content: Schedule + Student Pool -->
<div style="display: grid; grid-template-columns: 1fr 320px; gap: 30px; margin-top: 30px;">
    <!-- Left: Day Boxes in Grid -->
    <div>
        <div class="days-grid">
        {% for date_str in week_data.sorted_dates %}
        {% set day_data = week_data.duties_by_day[date_str] %}
        {% set am_duty = day_data.AM %}
        {% set pm_duty = day_data.PM %}

        <div class="day-box">
            <div class="day-header">
                {{ day_data.date.strftime('%A') }}
                <span class="day-date">{{ day_data.date.strftime('%b %d') }}</span>
            </div>

            <!-- AM Shift -->
            <div class="shift-section am-shift">
                <div class="shift-label">‚òÄÔ∏è AM</div>
                <div class="duty-slots">
                    <!-- AM Slot 1 -->
                    <div class="duty-slot {% if am_duty and am_duty.student1 %}filled{% endif %}" 
                         data-duty-id="{{ am_duty.id if am_duty else '' }}"
                         data-slot="student1"
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnter(event)"
                         ondragleave="dragLeave(event)">
                        <span class="slot-label">1</span>
                        {% if am_duty and am_duty.student1 %}
                        <div class="student-card" 
                             draggable="true"
                             ondragstart="dragStart(event)"
                             ondragend="dragEnd(event)"
                             data-student-id="{{ am_duty.student1.id }}"
                             data-duty-id="{{ am_duty.id }}"
                             data-slot="student1">
                            <div class="student-name">{{ am_duty.student1.full_name }}</div>
                            <div class="student-grade">
                                {% if am_duty.student1.grade %}
                                <span class="grade-badge">Grade {{ am_duty.student1.grade }}</span>
                                {% else %}
                                <span class="grade-badge">No Grade</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- AM Slot 2 -->
                    <div class="duty-slot {% if am_duty and am_duty.student2 %}filled{% endif %}"
                         data-duty-id="{{ am_duty.id if am_duty else '' }}"
                         data-slot="student2"
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnter(event)"
                         ondragleave="dragLeave(event)">
                        <span class="slot-label">2</span>
                        {% if am_duty and am_duty.student2 %}
                        <div class="student-card" 
                             draggable="true"
                             ondragstart="dragStart(event)"
                             ondragend="dragEnd(event)"
                             data-student-id="{{ am_duty.student2.id }}"
                             data-duty-id="{{ am_duty.id }}"
                             data-slot="student2">
                            <div class="student-name">{{ am_duty.student2.full_name }}</div>
                            <div class="student-grade">
                                {% if am_duty.student2.grade %}
                                <span class="grade-badge">Grade {{ am_duty.student2.grade }}</span>
                                {% else %}
                                <span class="grade-badge">No Grade</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- PM Shift -->
            <div class="shift-section pm-shift">
                <div class="shift-label">üåô PM</div>
                <div class="duty-slots">
                    <!-- PM Slot 1 -->
                    <div class="duty-slot {% if pm_duty and pm_duty.student1 %}filled{% endif %}"
                         data-duty-id="{{ pm_duty.id if pm_duty else '' }}"
                         data-slot="student1"
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnter(event)"
                         ondragleave="dragLeave(event)">
                        <span class="slot-label">1</span>
                        {% if pm_duty and pm_duty.student1 %}
                        <div class="student-card" 
                             draggable="true"
                             ondragstart="dragStart(event)"
                             ondragend="dragEnd(event)"
                             data-student-id="{{ pm_duty.student1.id }}"
                             data-duty-id="{{ pm_duty.id }}"
                             data-slot="student1">
                            <div class="student-name">{{ pm_duty.student1.full_name }}</div>
                            <div class="student-grade">
                                {% if pm_duty.student1.grade %}
                                <span class="grade-badge">Grade {{ pm_duty.student1.grade }}</span>
                                {% else %}
                                <span class="grade-badge">No Grade</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PM Slot 2 -->
                    <div class="duty-slot {% if pm_duty and pm_duty.student2 %}filled{% endif %}"
                         data-duty-id="{{ pm_duty.id if pm_duty else '' }}"
                         data-slot="student2"
                         ondrop="drop(event)" 
                         ondragover="allowDrop(event)"
                         ondragenter="dragEnter(event)"
                         ondragleave="dragLeave(event)">
                        <span class="slot-label">2</span>
                        {% if pm_duty and pm_duty.student2 %}
                        <div class="student-card" 
                             draggable="true"
                             ondragstart="dragStart(event)"
                             ondragend="dragEnd(event)"
                             data-student-id="{{ pm_duty.student2.id }}"
                             data-duty-id="{{ pm_duty.id }}"
                             data-slot="student2">
                            <div class="student-name">{{ pm_duty.student2.full_name }}</div>
                            <div class="student-grade">
                                {% if pm_duty.student2.grade %}
                                <span class="grade-badge">Grade {{ pm_duty.student2.grade }}</span>
                                {% else %}
                                <span class="grade-badge">No Grade</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        </div>
    </div>

    <!-- Right: Student Pool -->
    <div>
        <div class="student-pool">
            <h3>üë• Students (Table {{ week_data.weekly_assignment.table_number }})</h3>
            {% set table_students = namespace(items=[]) %}
            {% for date_str in week_data.sorted_dates %}
                {% set day_data = week_data.duties_by_day[date_str] %}
                {% for duty in [day_data.AM, day_data.PM] if duty %}
                    {% if duty.student1 and duty.student1 not in table_students.items %}
                        {% set _ = table_students.items.append(duty.student1) %}
                    {% endif %}
                    {% if duty.student2 and duty.student2 not in table_students.items %}
                        {% set _ = table_students.items.append(duty.student2) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}

            {% for student in table_students.items %}
            <div class="student-pool-item"
                 draggable="true"
                 ondragstart="dragStart(event)"
                 ondragend="dragEnd(event)"
                 data-student-id="{{ student.id }}">
                <div class="student-name">{{ student.full_name }}</div>
                <div class="student-grade">
                    {% if student.grade %}
                    <span class="grade-badge">Grade {{ student.grade }}</span>
                    {% else %}
                    <span class="grade-badge">No Grade</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Trash Bin (appears when dragging from duty slots) -->
<div class="trash-bin" id="trashBin"
     ondrop="dropInTrash(event)"
     ondragover="allowDrop(event)"
     ondragenter="dragEnterTrash(event)"
     ondragleave="dragLeaveTrash(event)">
    <div>üóëÔ∏è</div>
    <div class="trash-bin-text">Drop to Remove</div>
</div>

<script>
let draggedElement = null;
let draggedFromSlot = false;

function dragStart(e) {
    draggedElement = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('student_id', e.target.dataset.studentId);

    draggedFromSlot = e.target.hasAttribute('data-duty-id') && e.target.dataset.dutyId;

    if (draggedFromSlot) {
        setTimeout(() => {
            document.getElementById('trashBin').classList.add('visible');
        }, 100);
    }
}

function dragEnd(e) {
    e.target.classList.remove('dragging');

    document.querySelectorAll('.duty-slot').forEach(slot => {
        slot.classList.remove('drag-over');
    });

    document.getElementById('trashBin').classList.remove('visible');
    document.getElementById('trashBin').classList.remove('drag-over-trash');
}

function allowDrop(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function dragEnter(e) {
    e.preventDefault();
    if (e.target.classList.contains('duty-slot')) {
        e.target.classList.add('drag-over');
    }
}

function dragLeave(e) {
    if (e.target.classList.contains('duty-slot')) {
        e.target.classList.remove('drag-over');
    }
}

function dragEnterTrash(e) {
    e.preventDefault();
    document.getElementById('trashBin').classList.add('drag-over-trash');
}

function dragLeaveTrash(e) {
    document.getElementById('trashBin').classList.remove('drag-over-trash');
}

function dropInTrash(e) {
    e.preventDefault();

    if (!draggedFromSlot || !draggedElement) {
        return;
    }

    const dutyId = draggedElement.dataset.dutyId;
    const slot = draggedElement.dataset.slot;

    if (!dutyId || !slot) {
        alert('Error: Cannot remove this student');
        return;
    }

    fetch('/duty/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            duty_id: parseInt(dutyId),
            slot: slot,
            student_id: null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const parentSlot = draggedElement.closest('.duty-slot');
            draggedElement.remove();
            parentSlot.classList.remove('filled');
            showMessage('Student removed from duty', 'success');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to remove student');
    });

    document.getElementById('trashBin').classList.remove('visible');
    document.getElementById('trashBin').classList.remove('drag-over-trash');
}

function drop(e) {
    e.preventDefault();

    let dropZone = e.target;
    if (!dropZone.classList.contains('duty-slot')) {
        dropZone = dropZone.closest('.duty-slot');
    }

    if (!dropZone) return;

    dropZone.classList.remove('drag-over');

    const dutyId = dropZone.dataset.dutyId;
    const slot = dropZone.dataset.slot;
    const studentId = e.dataTransfer.getData('student_id');

    if (!dutyId || !slot || !studentId) {
        alert('Error: Missing data for duty assignment');
        return;
    }

    const existingCard = dropZone.querySelector('.student-card');
    if (existingCard && existingCard !== draggedElement) {
        if (!confirm('This slot is already occupied. Replace the student?')) {
            return;
        }
        existingCard.remove();
    }

    updateDuty(dutyId, slot, studentId, dropZone, draggedElement);
}

function updateDuty(dutyId, slot, studentId, dropZone, draggedEl) {
    fetch('/duty/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            duty_id: parseInt(dutyId),
            slot: slot,
            student_id: parseInt(studentId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (draggedEl.parentElement.classList.contains('duty-slot')) {
                const oldSlot = draggedEl.closest('.duty-slot');
                draggedEl.remove();
                oldSlot.classList.remove('filled');
            }

            const newCard = draggedEl.cloneNode(true);
            newCard.dataset.dutyId = dutyId;
            newCard.dataset.slot = slot;

            dropZone.innerHTML = '<span class="slot-label">' + 
                (slot === 'student1' ? '1' : '2') + '</span>';
            dropZone.appendChild(newCard);
            dropZone.classList.add('filled');

            showMessage('Student assigned successfully!', 'success');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update duty assignment');
    });
}

function regenerateWeek() {
    if (!confirm('Auto-generate duty assignments for this week? This will overwrite current assignments.')) {
        return;
    }

    const weeklyAssignmentId = {{ week_data.weekly_assignment.id if week_data else 'null' }};

    fetch('/duty/regenerate_week', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            weekly_assignment_id: weeklyAssignmentId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Week regenerated successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to regenerate week');
    });
}

function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';

    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>

{% else %}
<div class="card" style="margin-top: 20px; text-align: center; padding: 60px;">
    <h3 style="color: #7f8c8d; margin-bottom: 15px;">No duties scheduled for this week</h3>
    <p style="color: #95a5a6; margin-bottom: 25px;">Generate a schedule for this term</p>
    <a href="{{ url_for('generate_schedule', term_id=selected_term.id) }}" 
       class="btn btn-primary"
       onclick="return confirm('Generate duty schedule?')">
        üîÑ Generate Schedule
    </a>
</div>
{% endif %}

{% endif %}
{% endblock %}